{% extends "base.html" %}

{% block title %}AI Predictions - Agri Prosper{% endblock %}

{% block extra_css %}
<style>
    .prediction-card {
        background: white;
        border-radius: 16px;
        border: 1px solid rgba(34, 197, 94, 0.1);
        transition: all 0.3s ease;
    }

    .prediction-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(34, 197, 94, 0.1);
    }

    .upload-zone {
        border: 2px dashed var(--primary-color);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .upload-zone:hover {
        background: rgba(34, 197, 94, 0.05);
    }

    .result-card {
        background: white;
        border-radius: 12px;
        border: 1px solid rgba(34, 197, 94, 0.1);
        padding: 1.5rem;
    }

    .health-indicator {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        font-weight: bold;
        margin: 0 auto;
    }

    .health-good {
        background: rgba(34, 197, 94, 0.1);
        color: var(--primary-color);
    }

    .health-warning {
        background: rgba(245, 158, 11, 0.1);
        color: var(--warning-color);
    }

    .health-critical {
        background: rgba(239, 68, 68, 0.1);
        color: var(--danger-color);
    }

    .result-card img {
        max-height: 300px;
        object-fit: contain;
        width: 100%;
        border: 1px solid rgba(34, 197, 94, 0.1);
        border-radius: 8px;
    }

    .prediction-confidence {
        font-weight: 500;
        padding: 2px 8px;
        border-radius: 999px;
    }

    .prediction-high {
        background-color: rgba(239, 68, 68, 0.1);
        color: rgb(239, 68, 68);
    }

    .prediction-medium {
        background-color: rgba(245, 158, 11, 0.1);
        color: rgb(245, 158, 11);
    }

    .prediction-low {
        background-color: rgba(34, 197, 94, 0.1);
        color: rgb(34, 197, 94);
    }

    .recommendation-card {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        margin-bottom: 1rem;
        border: 1px solid rgba(34, 197, 94, 0.1);
    }

    .recommendation-card:last-child {
        margin-bottom: 0;
    }

    .recommendation-card ul li {
        position: relative;
        padding-left: 1.5rem;
    }

    .recommendation-card ul li i {
        position: absolute;
        left: 0;
        top: 0.25rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="space-y-6">
    <!-- Header -->
    <div class="flex justify-between items-center">
        <div>
            <h1 class="text-2xl font-semibold text-gray-800">AI Predictions</h1>
            <p class="text-gray-600 mt-1">Leverage AI to optimize your greenhouse operations</p>
        </div>
    </div>

    <!-- AI Features Grid -->
    <div class="space-y-6">
        <!-- First row with 3 cards -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <!-- Disease Detection -->
            <div class="prediction-card p-6">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-microscope text-green-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 ml-4">Disease Detection</h3>
                </div>
                
                <div class="upload-zone" id="diseaseUploadZone">
                    <input type="file" id="diseaseInput" class="hidden" accept="image/*">
                    <i class="fas fa-cloud-upload-alt text-4xl text-green-600 mb-4"></i>
                    <p class="text-gray-600">Drop your plant image here or click to upload</p>
                </div>

                <div id="diseaseResult" class="result-card mt-4 hidden">
                    <h4 class="font-semibold text-gray-800 mb-3">Detection Results</h4>
                    <div id="diseaseDetails"></div>
                </div>
            </div>
            
            <!-- Crop Quality Card - Fixed structure -->
            <div class="prediction-card p-6">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-leaf text-green-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 ml-4">Crop Quality</h3>
                </div>

                <form id="qualityForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Crop Type</label>
                            <select id="crop" name="crop" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option value="TOMATO">Tomato</option>
                                <option value="LETTUCE">Lettuce</option>
                                <option value="CUCUMBER">Cucumber</option>
                                <option value="BASIL">Basil</option>
                                <option value="SPINACH">Spinach</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Growth Stage</label>
                            <select id="growth_stage" name="growth_stage" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                                <option value="GERMINATION">Germination</option>
                                <option value="VEGETATIVE">Vegetative</option>
                                <option value="FLOWERING">Flowering</option>
                                <option value="FRUITING">Fruiting</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Temperature (°C)</label>
                            <input type="number" id="temperature" name="temperature" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                value="24" min="15" max="35" step="0.1" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Humidity (%)</label>
                            <input type="number" id="humidity" name="humidity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                value="65" min="30" max="90" step="1" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">CO2 Level (ppm)</label>
                            <input type="number" id="co2_level" name="co2_level" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                value="800" min="350" max="2000" step="10" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">PPFD (μmol/m²/s)</label>
                            <input type="number" id="ppfd" name="ppfd" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                value="300" min="100" max="1000" step="10" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">pH Level</label>
                            <input type="number" id="ph" name="ph" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                value="6.0" min="5.0" max="7.5" step="0.1" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">EC (mS/cm)</label>
                            <input type="number" id="ec" name="ec" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                value="1.8" min="0.5" max="3.5" step="0.1" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Leaf Color Index (0-1)</label>
                            <input type="number" id="leaf_color_index" name="leaf_color_index" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                value="0.8" min="0" max="1" step="0.1" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Stem Thickness (mm)</label>
                            <input type="number" id="stem_thickness" name="stem_thickness" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                value="8" min="1" max="25" step="0.5" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Plant Height (cm)</label>
                            <input type="number" id="plant_height" name="plant_height" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                value="45" min="5" max="200" step="1" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Days Since Planting</label>
                            <input type="number" id="days_since_planting" name="days_since_planting" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                value="30" min="1" max="150" step="1" required>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Nitrogen Level (0-1)</label>
                            <input type="number" id="nitrogen_level" name="nitrogen_level" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                value="0.7" min="0" max="1" step="0.1" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Phosphorus Level (0-1)</label>
                            <input type="number" id="phosphorus_level" name="phosphorus_level" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                value="0.6" min="0" max="1" step="0.1" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Potassium Level (0-1)</label>
                            <input type="number" id="potassium_level" name="potassium_level" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                value="0.6" min="0" max="1" step="0.1" required>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Water TDS (ppm)</label>
                        <input type="number" id="water_tds" name="water_tds" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                            value="450" min="100" max="1500" step="10" required>
                    </div>

                    <button type="submit" class="btn btn-primary w-full">
                        Analyze Quality
                    </button>
                </form>

                <div id="qualityResult" class="result-card mt-4 hidden">
                    <div id="qualityIndicator" class="health-indicator health-good mb-4">0.0</div>
                    <h4 id="qualityCategory" class="font-semibold text-gray-800 mb-2 text-center">Analyzing...</h4>
                    <div class="mt-4">
                        <h5 class="font-medium text-gray-700 mb-2">Recommendations:</h5>
                        <ul id="qualityRecommendations" class="text-sm text-gray-600 space-y-2">
                            <!-- Recommendations will be added here -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Predictive Maintenance -->
            <div class="prediction-card p-6">
                <div class="flex items-center mb-4">
                    <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-tools text-green-600 text-xl"></i>
                    </div>
                    <h3 class="text-lg font-semibold text-gray-800 ml-4">Predictive Maintenance</h3>
                </div>

                <form id="maintenanceForm" class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Equipment Age (years)</label>
                        <input type="number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0" step="0.5">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Last Maintenance (days ago)</label>
                        <input type="number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" min="0">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700">Operating Temperature (°C)</label>
                        <input type="number" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    </div>

                    <button type="submit" class="btn btn-primary w-full">
                        Check Maintenance Status
                    </button>
                </form>

                <div id="maintenanceResult" class="result-card mt-4 hidden">
                    <div class="health-indicator health-warning mb-4">
                        <i class="fas fa-wrench text-3xl"></i>
                    </div>
                    <h4 class="font-semibold text-gray-800 mb-2 text-center">Maintenance Recommended</h4>
                    <div class="text-sm text-gray-600 space-y-2">
                        <p><i class="fas fa-calendar-alt mr-2"></i>Next service: <span class="font-medium">2023-05-20</span></p>
                        <p><i class="fas fa-chart-line mr-2"></i>Health score: <span class="font-medium">75%</span></p>
                        <div class="mt-3">
                            <p class="font-medium mb-1">Issues detected:</p>
                            <ul class="list-disc list-inside space-y-1 text-gray-500">
                                <li>High operating temperature</li>
                                <li>Routine maintenance due</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Crop Yield Predictor -->
        <div class="prediction-card p-6">
            <div class="flex items-center mb-4">
                <div class="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                    <i class="fas fa-seedling text-green-600 text-xl"></i>
                </div>
                <h3 class="text-lg font-semibold text-gray-800 ml-4">Crop Yield Predictor</h3>
            </div>

            <form id="yieldForm" class="space-y-4">
                <!-- Basic Settings -->
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Crop Type</label>
                        <select id="cropType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="Tomato">Tomato</option>
                            <option value="Lettuce">Lettuce</option>
                            <option value="Basil">Basil</option>
                            <option value="Spinach">Spinach</option>
                            <option value="Cucumber">Cucumber</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Growing System</label>
                        <select id="growingSystem" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                            <option value="NFT">NFT</option>
                            <option value="DWC">DWC</option>
                            <option value="Vertical">Vertical</option>
                            <option value="Traditional">Traditional</option>
                        </select>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700">Greenhouse Area (m²)</label>
                    <input type="number" id="greenhouseArea" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                        min="1" step="0.1" value="1" required>
                </div>

                <!-- Growth Stages -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Germination Stage -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-700 mb-3">Germination Stage</h4>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600">Temperature (°C)</label>
                                    <input type="number" id="germination_temp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="18" min="15" max="35" required>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">Humidity (%)</label>
                                    <input type="number" id="germination_humidity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="40" min="30" max="90" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600">LED Red</label>
                                    <input type="number" id="germination_led_r" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="100" min="0" max="100" required>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">LED Green</label>
                                    <input type="number" id="germination_led_g" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="100" min="0" max="100" required>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">LED Blue</label>
                                    <input type="number" id="germination_led_b" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="100" min="0" max="100" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Vegetative Stage -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-700 mb-3">Vegetative Stage</h4>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600">Temperature (°C)</label>
                                    <input type="number" id="vegetative_temp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="18" min="15" max="35" required>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">Humidity (%)</label>
                                    <input type="number" id="vegetative_humidity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="40" min="30" max="90" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600">LED Red</label>
                                    <input type="number" id="vegetative_led_r" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="100" min="0" max="100" required>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">LED Green</label>
                                    <input type="number" id="vegetative_led_g" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="100" min="0" max="100" required>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">LED Blue</label>
                                    <input type="number" id="vegetative_led_b" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="100" min="0" max="100" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Flowering Stage -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-700 mb-3">Flowering Stage</h4>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600">Temperature (°C)</label>
                                    <input type="number" id="flowering_temp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="18" min="15" max="35" required>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">Humidity (%)</label>
                                    <input type="number" id="flowering_humidity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="40" min="30" max="90" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600">LED Red</label>
                                    <input type="number" id="flowering_led_r" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="100" min="0" max="100" required>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">LED Green</label>
                                    <input type="number" id="flowering_led_g" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="100" min="0" max="100" required>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">LED Blue</label>
                                    <input type="number" id="flowering_led_b" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="100" min="0" max="100" required>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Fruiting Stage -->
                    <div class="p-4 bg-gray-50 rounded-lg">
                        <h4 class="font-medium text-gray-700 mb-3">Fruiting Stage</h4>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600">Temperature (°C)</label>
                                    <input type="number" id="fruiting_temp" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="18" min="15" max="35" required>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">Humidity (%)</label>
                                    <input type="number" id="fruiting_humidity" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="40" min="30" max="90" required>
                                </div>
                            </div>
                            <div class="grid grid-cols-3 gap-4">
                                <div>
                                    <label class="block text-sm text-gray-600">LED Red</label>
                                    <input type="number" id="fruiting_led_r" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="100" min="0" max="100" required>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">LED Green</label>
                                    <input type="number" id="fruiting_led_g" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="100" min="0" max="100" required>
                                </div>
                                <div>
                                    <label class="block text-sm text-gray-600">LED Blue</label>
                                    <input type="number" id="fruiting_led_b" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" 
                                        value="100" min="0" max="100" required>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button type="submit" class="btn btn-primary w-full">
                    Predict Yield
                </button>
            </form>

            <div id="yieldResult" class="result-card mt-4 hidden">
                <div class="text-center">
                    <div class="health-indicator health-good mb-4">
                        <span id="totalYield">0</span>g
                    </div>
                    <h4 class="font-semibold text-gray-800">Predicted Total Yield</h4>
                </div>
                
                <div class="mt-4 grid grid-cols-2 gap-4">
                    <div class="p-3 bg-gray-50 rounded-lg text-center">
                        <div class="text-xl font-bold text-gray-800 mb-1" id="yieldPerPlant">0</div>
                        <div class="text-sm text-gray-600">Yield per Plant (g)</div>
                    </div>
                    <div class="p-3 bg-gray-50 rounded-lg text-center">
                        <div class="text-xl font-bold text-gray-800 mb-1" id="totalPlants">0</div>
                        <div class="text-sm text-gray-600">Total Plants</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Disease Detection
const diseaseUploadZone = document.getElementById('diseaseUploadZone');
const diseaseInput = document.getElementById('diseaseInput');
const diseaseResult = document.getElementById('diseaseResult');
const diseaseDetails = document.getElementById('diseaseDetails');

// Upload zone event listeners
diseaseUploadZone.addEventListener('click', () => diseaseInput.click());
diseaseUploadZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    diseaseUploadZone.classList.add('bg-green-50');
});
diseaseUploadZone.addEventListener('dragleave', () => {
    diseaseUploadZone.classList.remove('bg-green-50');
});
diseaseUploadZone.addEventListener('drop', (e) => {
    e.preventDefault();
    diseaseUploadZone.classList.remove('bg-green-50');
    const file = e.dataTransfer.files[0];
    handleDiseaseImage(file);
});
diseaseInput.addEventListener('change', (e) => {
    const file = e.target.files[0];
    handleDiseaseImage(file);
});

// Handle image upload and API call
function handleDiseaseImage(file) {
    // Show loading state
    diseaseResult.classList.remove('hidden');
    diseaseDetails.innerHTML = `
        <div class="flex items-center justify-center p-4">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-green-500"></div>
            <span class="ml-2 text-gray-600">Analyzing image...</span>
        </div>
    `;

    const formData = new FormData();
    formData.append('file', file);

    // Make API call to disease detection endpoint
    fetch('http://localhost:8000/api/detect/', {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('API Response:', data);
        displayDiseaseResults(data);
    })
    .catch(error => {
        console.error('Error:', error);
        diseaseDetails.innerHTML = `
            <div class="p-4 bg-red-50 text-red-600 rounded-lg">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Error processing image. Please try again.
            </div>
        `;
    });
}

// Display disease detection results
function displayDiseaseResults(data) {
    try {
        // Group similar predictions and take the highest confidence for each disease
        const groupedPredictions = data.predictions.reduce((acc, pred) => {
            const disease = pred.class;
            if (!acc[disease] || acc[disease].confidence < pred.confidence) {
                acc[disease] = pred;
            }
            return acc;
        }, {});

        // Convert grouped predictions back to array and sort by confidence
        const uniquePredictions = Object.values(groupedPredictions)
            .sort((a, b) => b.confidence - a.confidence);

        let resultsHtml = `
            <div class="space-y-4">
                <!-- Annotated Image -->
                <div class="mb-4">
                    <h5 class="font-medium text-gray-700 mb-2">Analyzed Image</h5>
                    <div class="relative">
                        <img src="http://localhost:8000${data.files.annotated_image}" 
                             alt="Annotated plant image" 
                             class="w-full rounded-lg shadow-sm"
                             onerror="this.classList.add('hidden'); this.nextElementSibling.classList.remove('hidden');">
                        <div class="hidden p-4 bg-red-50 text-red-600 rounded-lg">
                            Error loading annotated image
                        </div>
                    </div>
                </div>
                
                <!-- Predictions -->
                <div>
                    <h5 class="font-medium text-gray-700 mb-2">Detected Issues</h5>
                    <div class="space-y-2">
                        ${uniquePredictions.map(pred => `
                            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 transition-colors">
                                <div class="flex items-center">
                                    <i class="fas ${getConfidenceIcon(pred.confidence)} mr-3 text-${getConfidenceColor(pred.confidence)}"></i>
                                    <span class="text-gray-700">${formatDiseaseName(pred.class)}</span>
                                </div>
                                <span class="font-medium px-3 py-1 rounded-full bg-${getConfidenceColor(pred.confidence)}-100 text-${getConfidenceColor(pred.confidence)}-700">
                                    ${(pred.confidence * 100).toFixed(1)}%
                                </span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Recommendations -->
                <div class="mt-4 p-4 bg-green-50 rounded-lg">
                    <h5 class="font-medium text-gray-700 mb-3">
                        <i class="fas fa-lightbulb text-green-600 mr-2"></i>
                        Treatment Recommendations
                    </h5>
                    <div class="space-y-3">
                        ${uniquePredictions.map(pred => `
                            <div class="recommendation-card">
                                <h6 class="font-medium text-gray-700 mb-2">${formatDiseaseName(pred.class)}</h6>
                                <ul class="text-sm text-gray-600 space-y-2 ml-4">
                                    ${getDetailedRecommendation(pred.class).split('\n')
                                        .filter(item => item.trim())
                                        .map(item => `
                                            <li class="flex items-start">
                                                <i class="fas fa-check-circle text-green-600 mt-1 mr-2"></i>
                                                <span>${item.trim()}</span>
                                            </li>
                                        `).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        
        diseaseDetails.innerHTML = resultsHtml;

        // Add image load event listener for debugging
        const img = diseaseDetails.querySelector('img');
        img.addEventListener('load', () => {
            console.log('Annotated image loaded successfully');
        });
        img.addEventListener('error', (e) => {
            console.error('Error loading annotated image:', e);
        });

    } catch (error) {
        console.error('Error displaying results:', error);
        diseaseDetails.innerHTML = `
            <div class="p-4 bg-red-50 text-red-600 rounded-lg">
                <i class="fas fa-exclamation-circle mr-2"></i>
                Error displaying results. Please try again.
            </div>
        `;
    }
}

// Helper functions
function getConfidenceIcon(confidence) {
    if (confidence > 0.7) return 'fa-exclamation-circle';
    if (confidence > 0.5) return 'fa-exclamation-triangle';
    return 'fa-info-circle';
}

function getConfidenceColor(confidence) {
    if (confidence > 0.7) return 'red';
    if (confidence > 0.5) return 'yellow';
    return 'green';
}

function formatDiseaseName(name) {
    return name
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1))
        .join(' ');
}

function getDetailedRecommendation(diseaseType) {
    const recommendations = {
        'Tomato leaf late blight': `
            Remove and destroy infected plant parts immediately
            Improve greenhouse ventilation and air circulation
            Apply copper-based fungicide as preventive measure
            Water plants at the base to avoid leaf wetness
            Monitor and maintain optimal humidity levels
            Consider using resistant varieties in future plantings
            Implement strict sanitation practices
        `,
        'Tomato Early blight leaf': `
            Remove infected leaves and destroy them properly
            Apply appropriate fungicide according to severity
            Maintain proper plant spacing for better airflow
            Avoid overhead watering to prevent spread
            Rotate crops annually to break disease cycle
            Keep plants well-nourished to improve resistance
            Monitor and adjust humidity levels
        `,
        'Healthy': `
            Continue current maintenance practices
            Monitor plant health regularly
            Maintain optimal growing conditions
            Practice preventive care
        `
    };
    
    return recommendations[diseaseType] || `
        Consult with a plant pathologist for proper diagnosis
        Document symptoms and progression
        Isolate affected plants if possible
        Monitor environmental conditions
        Prepare samples for laboratory testing if needed
    `;
}

// Predictive Maintenance
const maintenanceForm = document.getElementById('maintenanceForm');
const maintenanceResult = document.getElementById('maintenanceResult');

maintenanceForm.addEventListener('submit', (e) => {
    e.preventDefault();
    
    // Gather form data
    const formData = {
        equipment_age: parseFloat(maintenanceForm.querySelector('input[type="number"]').value),
        last_maintenance: parseInt(maintenanceForm.querySelectorAll('input[type="number"]')[1].value),
        temperature: parseFloat(maintenanceForm.querySelectorAll('input[type="number"]')[2].value),
        vibration_level: 50,
        power_consumption: 8,
        humidity_exposure: 65,
        usage_hours: 2000
    };

    // Make API call
    fetch('http://localhost:8000/api/predict-maintenance/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        maintenanceResult.classList.remove('hidden');
        displayMaintenanceResults(data);
    })
    .catch(error => console.error('Error:', error));
});

function displayMaintenanceResults(data) {
    const indicator = maintenanceResult.querySelector('.health-indicator');
    const healthScore = maintenanceResult.querySelector('span:contains("Health score")');
    const nextService = maintenanceResult.querySelector('span:contains("Next service")');
    const issuesList = maintenanceResult.querySelector('ul');

    // Update health indicator class
    indicator.className = 'health-indicator ' + 
        (data.health_score >= 80 ? 'health-good' : 
         data.health_score >= 60 ? 'health-warning' : 
         'health-critical');

    // Update text content
    healthScore.textContent = `${data.health_score}%`;
    nextService.textContent = data.recommended_date;

    // Update issues list
    issuesList.innerHTML = data.issues.map(issue => 
        `<li>${issue}</li>`
    ).join('');
}

// Crop Yield Prediction
document.getElementById('yieldForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitButton = e.target.querySelector('button[type="submit"]');
    const yieldResult = document.getElementById('yieldResult');
    
    // Show loading state
    submitButton.disabled = true;
    submitButton.innerHTML = `
        <div class="flex items-center justify-center">
            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
            Calculating...
        </div>
    `;

    try {
        const requestData = {
            crop: document.getElementById('cropType').value,
            growing_system: document.getElementById('growingSystem').value,
            greenhouse_area: parseFloat(document.getElementById('greenhouseArea').value),
            germination: {
                temperature: parseFloat(document.getElementById('germination_temp').value),
                humidity: parseFloat(document.getElementById('germination_humidity').value),
                led_r: parseFloat(document.getElementById('germination_led_r').value),
                led_g: parseFloat(document.getElementById('germination_led_g').value),
                led_b: parseFloat(document.getElementById('germination_led_b').value)
            },
            vegetative: {
                temperature: parseFloat(document.getElementById('vegetative_temp').value),
                humidity: parseFloat(document.getElementById('vegetative_humidity').value),
                led_r: parseFloat(document.getElementById('vegetative_led_r').value),
                led_g: parseFloat(document.getElementById('vegetative_led_g').value),
                led_b: parseFloat(document.getElementById('vegetative_led_b').value)
            },
            flowering: {
                temperature: parseFloat(document.getElementById('flowering_temp').value),
                humidity: parseFloat(document.getElementById('flowering_humidity').value),
                led_r: parseFloat(document.getElementById('flowering_led_r').value),
                led_g: parseFloat(document.getElementById('flowering_led_g').value),
                led_b: parseFloat(document.getElementById('flowering_led_b').value)
            },
            fruiting: {
                temperature: parseFloat(document.getElementById('fruiting_temp').value),
                humidity: parseFloat(document.getElementById('fruiting_humidity').value),
                led_r: parseFloat(document.getElementById('fruiting_led_r').value),
                led_g: parseFloat(document.getElementById('fruiting_led_g').value),
                led_b: parseFloat(document.getElementById('fruiting_led_b').value)
            }
        };

        console.log('Sending request:', requestData);

        const response = await fetch('http://localhost:8000/api/predict-yield/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Received response:', data);

        // Update the results
        document.getElementById('totalYield').textContent = data.total_yield.toFixed(1);
        document.getElementById('yieldPerPlant').textContent = data.yield_per_plant.toFixed(1);
        document.getElementById('totalPlants').textContent = data.total_plants;

        // Show the results
        yieldResult.classList.remove('hidden');
        yieldResult.scrollIntoView({ behavior: 'smooth' });

    } catch (error) {
        console.error('Error:', error);
        alert('Error calculating yield. Please try again.');
    } finally {
        // Reset button state
        submitButton.disabled = false;
        submitButton.textContent = 'Predict Yield';
    }
});

// Crop Quality Prediction
document.getElementById('qualityForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const submitButton = e.target.querySelector('button[type="submit"]');
    const qualityResult = document.getElementById('qualityResult');
    const qualityIndicator = document.getElementById('qualityIndicator');
    const qualityCategory = document.getElementById('qualityCategory');
    const qualityRecommendations = document.getElementById('qualityRecommendations');
    
    // Show loading state
    submitButton.disabled = true;
    submitButton.innerHTML = `
        <div class="flex items-center justify-center">
            <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white mr-2"></div>
            Analyzing...
        </div>
    `;
    
    // Collect form data
    const formData = {
        crop: document.getElementById('crop').value,
        growth_stage: document.getElementById('growth_stage').value,
        temperature: parseFloat(document.getElementById('temperature').value),
        humidity: parseFloat(document.getElementById('humidity').value),
        co2_level: parseFloat(document.getElementById('co2_level').value),
        ppfd: parseFloat(document.getElementById('ppfd').value),
        ph: parseFloat(document.getElementById('ph').value),
        ec: parseFloat(document.getElementById('ec').value),
        leaf_color_index: parseFloat(document.getElementById('leaf_color_index').value),
        stem_thickness: parseFloat(document.getElementById('stem_thickness').value),
        plant_height: parseFloat(document.getElementById('plant_height').value),
        days_since_planting: parseInt(document.getElementById('days_since_planting').value),
        nitrogen_level: parseFloat(document.getElementById('nitrogen_level').value),
        phosphorus_level: parseFloat(document.getElementById('phosphorus_level').value),
        potassium_level: parseFloat(document.getElementById('potassium_level').value),
        water_tds: parseFloat(document.getElementById('water_tds').value)
    };

    try {
        console.log('Sending request:', formData);
        
        const response = await fetch('http://localhost:8000/api/predict-quality', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        });

        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }

        const data = await response.json();
        console.log('Received response:', data);
        
        // Update UI with results
        qualityIndicator.textContent = data.quality_score.toFixed(1);
        qualityCategory.textContent = data.quality_category;
        
        // Update health indicator color based on quality score
        qualityIndicator.className = 'health-indicator';
        if (data.quality_score >= 8) {
            qualityIndicator.classList.add('health-good');
        } else if (data.quality_score >= 6) {
            qualityIndicator.classList.add('health-warning');
        } else {
            qualityIndicator.classList.add('health-critical');
        }
        
        // Display recommendations
        qualityRecommendations.innerHTML = '';
        data.recommendations.forEach(recommendation => {
            const li = document.createElement('li');
            li.innerHTML = `<i class="fas fa-check-circle text-green-600 mr-2"></i>${recommendation}`;
            qualityRecommendations.appendChild(li);
        });
        
        // Show results
        qualityResult.classList.remove('hidden');
        qualityResult.scrollIntoView({ behavior: 'smooth' });
        
    } catch (error) {
        console.error('Error:', error);
        alert('Error analyzing crop quality. Please try again.');
    } finally {
        // Reset button state
        submitButton.disabled = false;
        submitButton.textContent = 'Analyze Quality';
    }
});
</script>
{% endblock %}